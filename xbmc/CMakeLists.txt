cmake_minimum_required(VERSION 2.8)

set(TARGET "i686-pc-linux-gnu")
set(TARGET_DIR "${SYSROOT}/usr/local")

include(ExternalProject)



file(WRITE ${CMAKE_BINARY_DIR}/xbmc_configure_helper.sh
"
#!/bin/sh
PF=`${SYSROOT}/usr/bin/${TARGET}-pkg-config --libs python`
export LDFLAGS=\"-L${TARGET_DIR}/lib -lgcc -lm -ltinyxml -lgdl -lismd_core -losal -lplatform_config\"
export CFLAGS=\"-DTARGET_BOXEE=1 -DTIXML_USE_STL -I${TARGET_DIR}/include -DHAS_INTEL_SMD\"
export CXXFLAGS=\"$CFLAGS\"
export FREETYPE2_CFLAGS=\"-I${TARGET_DIR}/include/freetype2\"
export PYTHON_VERSION=\"2.7.2\"
export PYTHON_NOVERSIONCHECK=\"y\"
export PYTHON=\"${TARGET_DIR}/bin/python\"
export PYTHON_CPPFLAGS=\"-I${TARGET_DIR}/include/python2.7\"
export PYTHON_LDFLAGS=\"\$PF -ldl -lpthread -lutil\"
../xbmc/configure --prefix=${TARGET_DIR} --host=${TARGET} --disable-gl --disable-sdl --disable-mysql --disable-x11 --disable-samba  --with-arch=i686 --with-platform=linux --enable-gles --enable-external-libraries --disable-joystick --disable-debug --disable-texturepacker
"
)
execute_process(COMMAND chmod +x ${CMAKE_BINARY_DIR}/xbmc_configure_helper.sh)

# Note to self: xbmc.patch generated by:
#     diff -x generated -w -r -u xbmc-12.2 xbmc | grep -v '^Only in' > /Volumes/Skivavbild/boxee-xbmc/xbmc/xbmc.patch

ExternalProject_Add(
	xbmc
	URL 				http://mirrors.xbmc.org/releases/source/xbmc-12.2.tar.gz
	URL_MD5 			489f3877decae4e265ece54f9eaef0ba
	PATCH_COMMAND		patch -p1 < ${CMAKE_SOURCE_DIR}/xbmc.patch
		COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/windowing/egl/EGLNativeTypeBoxee.cpp xbmc/windowing/egl/EGLNativeTypeBoxee.cpp
		COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/windowing/egl/EGLNativeTypeBoxee.h xbmc/windowing/egl/EGLNativeTypeBoxee.h
		COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/cores/IntelSMDGlobals.cpp xbmc/cores/IntelSMDGlobals.cpp
		COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/cores/IntelSMDGlobals.h xbmc/cores/IntelSMDGlobals.h
		COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/cores/VideoRenderers/IntelSMDRenderer.cpp xbmc/cores/VideoRenderers/IntelSMDRenderer.cpp
		COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/cores/VideoRenderers/IntelSMDRenderer.h xbmc/cores/VideoRenderers/IntelSMDRenderer.h
		COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/cores/dvdplayer/DVDCodecs/Video/IntelSMDVideo.cpp xbmc/cores/dvdplayer/DVDCodecs/Video/IntelSMDVideo.cpp
		COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/cores/dvdplayer/DVDCodecs/Video/IntelSMDVideo.h xbmc/cores/dvdplayer/DVDCodecs/Video/IntelSMDVideo.h
		COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/cores/dvdplayer/DVDCodecs/Video/DVDVideoCodecSMD.cpp xbmc/cores/dvdplayer/DVDCodecs/Video/DVDVideoCodecSMD.cpp
		COMMAND 		${CMAKE_COMMAND} -E copy_if_different ${CMAKE_SOURCE_DIR}/xbmc/cores/dvdplayer/DVDCodecs/Video/DVDVideoCodecSMD.h xbmc/cores/dvdplayer/DVDCodecs/Video/DVDVideoCodecSMD.h
	CONFIGURE_COMMAND	${CMAKE_BINARY_DIR}/xbmc_configure_helper.sh 
	BUILD_COMMAND 		make ${PARALLEL}
	BUILD_IN_SOURCE 	1
)
